{% extends 'bins/base.html' %}

{% block title %}Settings - Smart Waste Management{% endblock %}

{% block content %}
<div class="page-header">
  <h2>‚öôÔ∏è Settings</h2>
  <p>Configure your system preferences and location settings</p>
</div>

<form method="post" class="settings-form">
  {% csrf_token %}
  
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

<div class="settings-grid">
  <!-- Location Settings Section -->
  <div class="settings-section">
    <h3>üìç Location Settings</h3>
    
    <div class="setting-item">
      <div class="setting-info">
        <h4>üåç Your Location</h4>
        <p>Set your location for optimal route calculation</p>
      </div>
      <div class="setting-control">
        <div class="location-inputs">
          {{ form.latitude.label_tag }}
          {{ form.latitude }}
          {% if form.latitude.help_text %}
            <small class="help-text">{{ form.latitude.help_text }}</small>
          {% endif %}
          
          {{ form.longitude.label_tag }}
          {{ form.longitude }}
          {% if form.longitude.help_text %}
            <small class="help-text">{{ form.longitude.help_text }}</small>
          {% endif %}
        </div>
      </div>
    </div>
    
    <div class="setting-item">
      <div class="setting-info">
        <h4>üè† Location Name</h4>
        <p>Optional name or address for your location</p>
      </div>
      <div class="setting-control">
        {{ form.location_name }}
        {% if form.location_name.help_text %}
          <small class="help-text">{{ form.location_name.help_text }}</small>
        {% endif %}
      </div>
    </div>
    
    <div class="setting-item">
      <div class="setting-info">
        <h4>üîÑ Auto-Update Location</h4>
        <p>Automatically use current GPS location when available</p>
      </div>
      <div class="setting-control">
        <label class="toggle-switch">
          {{ form.auto_update_location }}
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
    
    <div class="location-actions">
      <button type="button" class="btn-primary" onclick="getCurrentLocation()">
        üì± Get Current Location
      </button>
      <button type="button" class="btn-secondary" onclick="testLocation()">
        üß™ Test Location
      </button>
    </div>
  </div>

  <!-- Notification Settings Section -->
  <div class="settings-section">
    <h3>üîî Notification Settings</h3>
    
    <div class="setting-item">
      <div class="setting-info">
        <h4>üìß Email Notifications</h4>
        <p>Receive email alerts for important system events</p>
      </div>
      <div class="setting-control">
        <label class="toggle-switch">
          {{ form.notify_email }}
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
    
    <div class="setting-item">
      <div class="setting-info">
        <h4>‚è±Ô∏è Polling Interval</h4>
        <p>How often to check for updates (seconds)</p>
      </div>
      <div class="setting-control">
        {{ form.polling_interval_sec }}
        {% if form.polling_interval_sec.help_text %}
          <small class="help-text">{{ form.polling_interval_sec.help_text }}</small>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Display Preferences Section -->
  <div class="settings-section">
    <h3>üé® Display Preferences</h3>
    
    <div class="setting-item">
      <div class="setting-info">
        <h4>üìè Density</h4>
        <p>Adjust the information density of the interface</p>
      </div>
      <div class="setting-control">
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="density" value="compact">
            <span>Compact</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="density" value="normal" checked>
            <span>Normal</span>
          </label>
          <label class="radio-option">
            <input type="radio" name="density" value="comfortable">
            <span>Comfortable</span>
          </label>
        </div>
      </div>
    </div>
  </div>
  
  <!-- AI & Analytics Section -->
  <div class="settings-section">
    <h3>ü§ñ AI & Analytics</h3>
    
    <div class="setting-item">
      <div class="setting-info">
        <h4>‚ö° Route Optimization</h4>
        <p>Default alpha value for route optimization algorithm</p>
      </div>
      <div class="setting-control">
        <div class="range-control">
          <input type="range" min="0" max="2" step="0.1" value="0.5" class="range-input" id="default-alpha" title="Default Alpha Value for Route Optimization" aria-label="Default Alpha Value">
          <span class="range-value">0.5</span>
        </div>
      </div>
    </div>
    
    <div class="ai-actions">
      <button type="button" class="btn-primary" onclick="trainModel()">
        üß† Train Model Now
      </button>
      <button type="button" class="btn-secondary" onclick="testPrediction()">
        üéØ Test Prediction
      </button>
    </div>
  </div>
  
  <!-- Current Location Info -->
  {% if form.instance.has_location %}
  <div class="settings-section location-info">
    <h3>üìä Current Location Status</h3>
    <div class="location-status">
      <div class="status-item">
        <span class="status-label">Latitude:</span>
        <span class="status-value">{{ form.instance.latitude|floatformat:6 }}</span>
      </div>
      <div class="status-item">
        <span class="status-label">Longitude:</span>
        <span class="status-value">{{ form.instance.longitude|floatformat:6 }}</span>
      </div>
      {% if form.instance.location_name %}
      <div class="status-item">
        <span class="status-label">Name:</span>
        <span class="status-value">{{ form.instance.location_name }}</span>
      </div>
      {% endif %}
      <div class="status-item">
        <span class="status-label">Last Updated:</span>
        <span class="status-value">{{ form.instance.updated_at|date:"M d, Y H:i" }}</span>
      </div>
    </div>
  </div>
  {% endif %}
</div>

</form>

<div class="settings-footer">
  <div class="form-actions">
    <button type="submit" class="btn-primary btn-large">
      üíæ Save Settings
    </button>
    <button type="button" class="btn-secondary" onclick="resetForm()">
      üîÑ Reset Changes
    </button>
  </div>
</div>

<style>
.location-inputs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1rem;
}

.location-inputs label {
  font-weight: 500;
  margin-bottom: 0.25rem;
  display: block;
}

.location-inputs input {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.help-text {
  color: #666;
  font-size: 0.85rem;
  margin-top: 0.25rem;
  display: block;
}

.location-actions, .ai-actions {
  margin-top: 1rem;
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.location-status {
  background: #f8f9fa;
  padding: 1rem;
  border-radius: 8px;
  margin-top: 1rem;
}

.status-item {
  display: flex;
  justify-content: space-between;
  padding: 0.5rem 0;
  border-bottom: 1px solid #e9ecef;
}

.status-item:last-child {
  border-bottom: none;
}

.status-label {
  font-weight: 500;
  color: #495057;
}

.status-value {
  color: #007bff;
  font-family: monospace;
}

.toggle-switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
  border-radius: 34px;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .toggle-slider {
  background-color: #007bff;
}

input:checked + .toggle-slider:before {
  transform: translateX(26px);
}

.range-control {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.range-input {
  flex: 1;
}

.range-value {
  min-width: 3rem;
  text-align: center;
  font-weight: 600;
}
</style>

<script>
// Location functionality
function getCurrentLocation() {
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        
        document.getElementById('id_latitude').value = lat.toFixed(6);
        document.getElementById('id_longitude').value = lng.toFixed(6);
        
        alert(`Location found: ${lat.toFixed(6)}, ${lng.toFixed(6)}\nClick "Save Settings" to store it.`);
      },
      function(error) {
        let message = "Location access denied.";
        switch(error.code) {
          case error.PERMISSION_DENIED:
            message = "Location access denied by user.";
            break;
          case error.POSITION_UNAVAILABLE:
            message = "Location information is unavailable.";
            break;
          case error.TIMEOUT:
            message = "Location request timed out.";
            break;
        }
        alert(message);
      }
    );
  } else {
    alert("Geolocation is not supported by this browser.");
  }
}

function testLocation() {
  const lat = document.getElementById('id_latitude').value;
  const lng = document.getElementById('id_longitude').value;
  
  if (!lat || !lng) {
    alert("Please enter both latitude and longitude first.");
    return;
  }
  
  // Test the location by calculating priorities
  fetch('/api/compute-route/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      user_lat: parseFloat(lat),
      user_lng: parseFloat(lng),
      top_n: 3
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.route) {
      alert(`Location test successful!\nTop 3 priority nodes found.\nRoute calculated with ${data.route.path.length} stops.`);
    } else {
      alert("Location test failed: " + (data.error || "Unknown error"));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert("Location test failed. Please check your connection and try again.");
  });
}

// Range input handlers
document.getElementById('default-alpha').addEventListener('input', function() {
  this.nextElementSibling.textContent = this.value;
});

// AI functions
function trainModel() {
  if (confirm('Training the AI model may take several minutes. Continue?')) {
    fetch('/api/train-model/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'trained') {
        alert(`Model training completed!\nVersion: ${data.meta.version}\nAccuracy: ${(data.meta.validation_r2 * 100).toFixed(1)}%`);
      } else {
        alert('Training failed: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Training failed. Please try again.');
    });
  }
}

function testPrediction() {
  fetch('/api/predict-cost/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.predictions && data.predictions.length > 0) {
      let message = `Prediction test successful!\n\nResults for ${data.predictions.length} nodes:\n`;
      data.predictions.slice(0, 3).forEach((pred, i) => {
        message += `Node ${pred.node_id}: Priority ${pred.predicted_cost.toFixed(3)}\n`;
      });
      alert(message);
    } else {
      alert('Prediction test failed: ' + (data.error || 'No predictions generated'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Prediction test failed. Please try again.');
  });
}

function resetForm() {
  if (confirm('Reset all changes to last saved values?')) {
    location.reload();
  }
}

// Helper function to get CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}