{% extends 'bins/base.html' %}

{% block title %}Dashboard - Smart Waste Management{% endblock %}

{% block content %}
<div class="page-header">
  <h2>📊 Dashboard</h2>
  <p>Real-time monitoring and smart optimization for waste management</p>
</div>

<!-- User Location Section -->
<section class="location-section">
  <div class="card location-card">
    <div class="card-header">
      <h3>📍 Your Location</h3>
      <div class="location-status">
        {% if user.settings.has_location %}
          <span class="status-indicator status-online"></span>
          <span class="status-text">Location Set</span>
        {% else %}
          <span class="status-indicator status-offline"></span>
          <span class="status-text">No Location</span>
        {% endif %}
      </div>
    </div>
    <div class="location-content">
      <div class="current-location">
        {% if user.settings.has_location %}
          <p><strong>Current Location:</strong> {{ user.settings.latitude|floatformat:4 }}, {{ user.settings.longitude|floatformat:4 }}</p>
          {% if user.settings.location_name %}
            <p><strong>Name:</strong> {{ user.settings.location_name }}</p>
          {% endif %}
        {% else %}
          <p>No location set. Please set your location to enable route optimization.</p>
        {% endif %}
      </div>
      
      <div class="location-controls">
        <div class="input-group">
          <input type="number" id="quick_latitude" placeholder="Latitude" step="any" class="form-control"
                 value="{% if user.settings.latitude %}{{ user.settings.latitude }}{% endif %}">
          <input type="number" id="quick_longitude" placeholder="Longitude" step="any" class="form-control"
                 value="{% if user.settings.longitude %}{{ user.settings.longitude }}{% endif %}">
        </div>
        <div class="button-group">
          <button onclick="getCurrentLocation()" class="btn-primary">
            📍 Get Current Location
          </button>
          <button onclick="updateLocation()" class="btn-secondary">
            💾 Save Location
          </button>
          <button onclick="calculateRouteFromLocation()" class="btn-success">
            🗺️ Calculate Route
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="dashboard-stats">
  <div class="stat-card">
    <div class="stat-icon">🗑️</div>
    <div class="stat-content">
      <h3>Active Bins</h3>
      <div class="stat-value">{{ active_bins|default:7 }}</div>
      <div class="stat-change positive">+2 this week</div>
    </div>
  </div>
  
  <div class="stat-card">
    <div class="stat-icon">📈</div>
    <div class="stat-content">
      <h3>Collection Rate</h3>
      <div class="stat-value">92%</div>
      <div class="stat-change positive">+5% vs last month</div>
    </div>
  </div>
  
  <div class="stat-card">
    <div class="stat-icon">🤖</div>
    <div class="stat-content">
      <h3>AI Accuracy</h3>
      <div class="stat-value">94.7%</div>
      <div class="stat-change positive">+1.2% improvement</div>
    </div>
  </div>
  
  <div class="stat-card">
    <div class="stat-icon">⏱️</div>
    <div class="stat-content">
      <h3>Avg Route Time</h3>
      <div class="stat-value">24min</div>
      <div class="stat-change negative">-8min optimized</div>
    </div>
  </div>
</section>

<section class="widgets">
  <div class="card readings-card">
    <div class="card-header">
      <h3>📡 Real-time Sensor Readings</h3>
      <div class="status-indicator status-online"></div>
      <span class="status-text">Live</span>
    </div>
    <div class="table-container">
      <table id="readings-table" class="data-table">
        <thead>
          <tr>
            <th>📍 Node</th>
            <th>🌡️ Temp (°C)</th>
            <th>💧 Humidity (%)</th>
            <th>💨 Gas Level</th>
            <th>🗑️ Waste Level</th>
            <th>⏰ Last Update</th>
            <th>📊 Status</th>
          </tr>
        </thead>
        <tbody>
          {% for r in latest_readings %}
          <tr>
            <td class="node-name">{{ r.node.name }}</td>
            <td class="temperature">{{ r.temperature|floatformat:1 }}</td>
            <td class="humidity">{{ r.humidity|floatformat:1 }}</td>
            <td class="gas-level">
              <div class="progress-bar">
                <div class="progress-fill" style="width: {{ r.gas_level|floatformat:0 }}%"></div>
              </div>
              <span>{{ r.gas_level|floatformat:2 }}</span>
            </td>
            <td class="waste-level">
              <div class="progress-bar waste-progress">
                <div class="progress-fill waste-fill" style="width: {{ r.waste_level|floatformat:0 }}%"></div>
              </div>
              <span>{{ r.waste_level|floatformat:2 }}</span>
            </td>
            <td class="timestamp">{{ r.node.last_update|default:r.timestamp }}</td>
            <td class="status">
              {% if r.waste_level > 0.8 %}
                <span class="badge badge-danger">Critical</span>
              {% elif r.waste_level > 0.6 %}
                <span class="badge badge-warning">High</span>
              {% else %}
                <span class="badge badge-success">Normal</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="no-data">
              <div class="empty-state">
                <span class="empty-icon">📊</span>
                <p>No sensor readings available</p>
                <small>Readings will appear here when sensors start reporting</small>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="card-footer">
      <small class="last-updated">Last updated: <span id="last-update">just now</span></small>
      <button class="btn-small" onclick="pollReadings()">🔄 Refresh</button>
    </div>
  </div>

  <!-- Priority Information Card -->
  {% if priority_info %}
  <div class="card priority-card">
    <div class="card-header">
      <h3>⭐ Node Priorities</h3>
      <small>Based on your location: {{ priority_info.user_location.lat|floatformat:4 }}, {{ priority_info.user_location.lng|floatformat:4 }}</small>
    </div>
    <div class="priority-content">
      <div class="priority-list">
        {% for node_id, node_name, score in priority_info.top_nodes %}
        <div class="priority-item">
          <span class="priority-rank">#{{ forloop.counter }}</span>
          <span class="priority-name">{{ node_name }}</span>
          <div class="priority-score">
            <div class="priority-bar">
              <div class="priority-fill" style="width: {{ score|floatformat:0 }}%"></div>
            </div>
            <span class="priority-value">{{ score|floatformat:3 }}</span>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  <div class="card route-card">
    <div class="card-header">
      <h3>🗺️ Optimized Collection Route</h3>
      <div class="route-controls">
        <label for="alpha" class="control-label">AI Weight (α):</label>
        <input id="alpha" type="range" min="0" max="2" step="0.1" value="0.5" class="alpha-slider">
        <span id="alpha-value" class="alpha-value">0.5</span>
      </div>
    </div>
    <div class="route-content">
      <pre id="route-card" class="route-display">{{ latest_route|default:"No route computed yet. Set your location and click 'Calculate Route' to generate an optimized path." }}</pre>
    </div>
    <div class="card-footer">
      <button onclick="computeRoute()" class="btn-primary">
        🧮 Compute Optimal Route
      </button>
      <button onclick="clearRoute()" class="btn-secondary">
        🗑️ Clear Route
      </button>
    </div>
  </div>

  <div class="card system-card">
    <div class="card-header">
      <h3>⚙️ System Health</h3>
    </div>
    <div class="system-stats">
      <div class="system-item">
        <span class="system-label">🕐 Server Time:</span>
        <span id="server-time" class="system-value">{{ now|date:"H:i:s" }}</span>
      </div>
      <div class="system-item">
        <span class="system-label">🤖 Model Version:</span>
        <span id="model-version" class="system-value">{{ model_version|default:"v1.0.0" }}</span>
      </div>
      <div class="system-item">
        <span class="system-label">📡 API Status:</span>
        <span class="system-value">
          <span class="status-indicator status-online"></span>
          <span class="status-text">Online</span>
        </span>
      </div>
      <div class="system-item">
        <span class="system-label">🔄 Auto-refresh:</span>
        <span class="system-value">
          <button id="auto-refresh-toggle" onclick="toggleAutoRefresh()" class="btn-small btn-toggle active">
            ON
          </button>
        </span>
      </div>
    </div>
    <div class="performance-metrics">
      <h4>📈 Performance Metrics</h4>
      <div class="metric">
        <span class="metric-label">Response Time:</span>
        <span class="metric-value">
          <span id="response-time">142ms</span>
          <span class="badge badge-success">Fast</span>
        </span>
      </div>
      <div class="metric">
        <span class="metric-label">Database:</span>
        <span class="metric-value">
          <span class="status-indicator status-online"></span>
          <span>Connected</span>
        </span>
      </div>
    </div>
  </div>
</section>

<style>
.location-section {
  margin-bottom: 2rem;
}

.location-card {
  background: var(--color-accent);
  color: var(--text-on-dark);
}

.location-card .card-header {
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.location-content {
  padding: 1.5rem;
}

.current-location {
  margin-bottom: 1rem;
  padding: 1rem;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
}

.input-group {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.input-group input {
  flex: 1;
  padding: 0.5rem;
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 4px;
  background: rgba(255, 255, 255, 0.1);
  color: white;
}

.input-group input::placeholder {
  color: rgba(255, 255, 255, 0.7);
}

.button-group {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.button-group button {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

.waste-progress .waste-fill {
  background: var(--color-accent);
}

.priority-card {
  min-height: 300px;
}

.priority-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.priority-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.75rem;
  background: var(--color-light);
  border-radius: var(--border-radius);
  border-left: 4px solid var(--color-accent);
}

.priority-rank {
  font-weight: bold;
  color: var(--color-accent);
  min-width: 2rem;
}

.priority-name {
  flex: 1;
  font-weight: 500;
  color: var(--text-primary);
}

.priority-score {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  min-width: 150px;
}

.priority-bar {
  flex: 1;
  height: 8px;
  background: var(--color-light);
  border-radius: var(--border-radius);
  overflow: hidden;
}

.priority-fill {
  height: 100%;
  background: var(--color-accent);
  transition: width 0.3s ease;
}

.priority-value {
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text-secondary);
  min-width: 3rem;
}
</style>

<script>
// Enhanced dashboard interactions
document.getElementById('alpha').addEventListener('input', function() {
  document.getElementById('alpha-value').textContent = this.value;
});

let autoRefresh = true;

function toggleAutoRefresh() {
  autoRefresh = !autoRefresh;
  const button = document.getElementById('auto-refresh-toggle');
  button.textContent = autoRefresh ? 'ON' : 'OFF';
  button.classList.toggle('active', autoRefresh);
}

function clearRoute() {
  document.getElementById('route-card').textContent = 'Route cleared. Set your location and click "Calculate Route" to generate a new path.';
}

// Location functionality
function getCurrentLocation() {
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        
        document.getElementById('quick_latitude').value = lat.toFixed(6);
        document.getElementById('quick_longitude').value = lng.toFixed(6);
        
        alert(`Location found: ${lat.toFixed(6)}, ${lng.toFixed(6)}\nClick "Save Location" to store it.`);
      },
      function(error) {
        let message = "Location access denied.";
        switch(error.code) {
          case error.PERMISSION_DENIED:
            message = "Location access denied by user.";
            break;
          case error.POSITION_UNAVAILABLE:
            message = "Location information is unavailable.";
            break;
          case error.TIMEOUT:
            message = "Location request timed out.";
            break;
        }
        alert(message);
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 300000
      }
    );
  } else {
    alert("Geolocation is not supported by this browser.");
  }
}

function updateLocation() {
  const lat = document.getElementById('quick_latitude').value;
  const lng = document.getElementById('quick_longitude').value;
  
  if (!lat || !lng) {
    alert("Please enter both latitude and longitude.");
    return;
  }
  
  fetch('/api/update-location/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      latitude: parseFloat(lat),
      longitude: parseFloat(lng)
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert("Location updated successfully!");
      location.reload();
    } else {
      alert("Error updating location: " + (data.error || "Unknown error"));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert("Error updating location. Please try again.");
  });
}

function calculateRouteFromLocation() {
  const lat = document.getElementById('quick_latitude').value;
  const lng = document.getElementById('quick_longitude').value;
  
  if (!lat || !lng) {
    alert("Please enter both latitude and longitude first.");
    return;
  }
  
  computeRouteWithLocation(parseFloat(lat), parseFloat(lng));
}

function computeRouteWithLocation(userLat, userLng) {
  const alpha = document.getElementById('alpha').value;
  
  fetch('/api/compute-route/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      user_lat: userLat,
      user_lng: userLng,
      top_n: 5,
      alpha: parseFloat(alpha)
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.route) {
      document.getElementById('route-card').textContent = JSON.stringify(data.route, null, 2);
    } else {
      document.getElementById('route-card').textContent = 'Error: ' + (data.error || 'Unknown error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    document.getElementById('route-card').textContent = 'Error computing route. Please try again.';
  });
}

function computeRoute() {
  {% if user.settings.has_location %}
    computeRouteWithLocation({{ user.settings.latitude }}, {{ user.settings.longitude }});
  {% else %}
    alert("Please set your location first using the location controls above.");
  {% endif %}
}

// Helper function to get CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}